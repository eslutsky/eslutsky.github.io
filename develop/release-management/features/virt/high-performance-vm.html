<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie10 lt-ie9 lt-ie8 lt-ie7" lang="en-us"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie10 lt-ie9 lt-ie8" lang="en-us"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie10 lt-ie9" lang="en-us"> <![endif]-->
<!--[if IE 9]> <html class="no-js lt-ie10 lt-ie9" lang="en-us"> <![endif]-->
<!--[if lt IE 10]> <html class="no-js lt-ie10" lang="en-us"> <![endif]-->
<!--[if !IE]> > <![endif]-->
<html class='no-js' lang='en'>
<!-- <![endif] -->
<head>
<title>
High Performance VM &mdash;
oVirt
</title>
<meta charset='utf-8'>
<meta content='' name='description'>
<meta content='' name='author'>
<meta content='initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width' name='viewport'>

<link href='/images/favicon.ico' rel='shortcut icon'>
<link href='/images/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'>
<link href='/images/apple-touch-icon-57x57-precomposed.png' rel='apple-touch-icon-precomposed' sizes='57x57'>
<link href='/images/apple-touch-icon-72x72-precomposed.png' rel='apple-touch-icon-precomposed' sizes='72x72'>
<link href='/images/apple-touch-icon-114x114-precomposed.png' rel='apple-touch-icon-precomposed' sizes='114x114'>
<link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>
<link href="/stylesheets/application.css?1560777611" rel="stylesheet" type="text/css" />
<link href="/stylesheets/print.css?1560777612" rel="stylesheet" type="text/css" media="print" />
</head>
<body class=' source-md'>
<header class='masthead hidden-print' id='branding' role='banner'>
<section class='hgroup'></section>
<div id='access'>
<nav id="mainNav" class="navbar-fixed-top affix-top navForMobileHack" style="font-family: 'Open Sans', sans-serif; display: flex; justify-content: center;">
      <a href="/"><img id="logo" style="float: left; margin-right: 70px; height: 40px; padding: 0; margin-top: 12px;" alt="oVirt" src="/images/logo.svg"></a>
      <div>
          <div class="navbar-header page-scroll" style="min-width: 170px">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#menu_id0980fddf">
                  <span class="sr-only">Toggle navigation</span> Menu <i class="fa fa-bars"></i>
              </button>
          </div>

          <!-- Collect the nav links, forms, and other content for toggling -->
          <div class="collapse navbar-collapse" id="menu_id0980fddf">

              <ul class="nav navbar-nav">
                  <li class="hidden active">
                      <a href="#page-top"></a>
                  </li>
<li role='menuitem'>
  <a href='/'>Home</a>
</li>

<li role='menuitem'>
  <a href='/download/'>Download</a>
</li>

<li role='menuitem'>
  <a href='/documentation/'>Documentation</a>
</li>

<li role='menuitem'>
  <a href='/develop/'>Developers</a>
</li>

<li role='menuitem'>
  <a href='/community/'>Community</a>
</li>

<li role='menuitem'>
  <a href='//lists.ovirt.org/archives/'>Forum</a>
</li>

<li role='menuitem'>
  <a href='/blog/'>Blog</a>
</li>

              </ul>
          </div>
          <!-- /.navbar-collapse -->
      </div>
      <!-- /.container-fluid -->
  </nav>

</div>
</header>

<section class='page-wrap' id='page-wrap'>
<section class='page' id='page'>
<ul class='breadcrumb'>
<li><a href="/develop/">Develop</a></li>
<li><a href="/develop/release-management/">Release-management</a></li>
<li><a href="/develop/release-management/features/">Features</a></li>
<li><a href="/develop/release-management/features/virt/">Virt</a></li>
</ul>

<section class='container content' id='content'>
<div class='alert alert-warning'>
Feature pages are design documents that developers have created while collaborating on oVirt.
<br>
<br>
Most of them are
<strong>
outdated
</strong>
, but provide historical design context.
<br>
<br>
They are
<strong>
not
</strong>
user documentation and should not be treated as such.
<br>
<br>
<a href='/documentation/'>Documentation is available here.</a>
</div>
<h1 id="high-performance-vm">High Performance VM</h1>

<h2 id="summary">Summary</h2>

<p>Support a new type of VM in oVirt destined for running a VM with highest possible performance and performance metrics as close to bare metal as possible.</p>

<p>For setting a VM as High Performance, a new VM profile type named "High Performance" will be added in addition to existing "Server", "Desktop" types.  By choosing This new High Performance VM type,  the VM will be pre-configured with a set of suggested and recommended configuration settings for reaching the best efficiency.</p>

<h2 id="owner">Owner</h2>
<ul>
  <li>Name: Sharon Gratch (sgratch)</li>
  <li>Email: <a href="&#109;&#097;&#105;&#108;&#116;&#111;:&#115;&#103;&#114;&#097;&#116;&#099;&#104;&#064;&#114;&#101;&#100;&#104;&#097;&#116;&#046;&#099;&#111;&#109;">&#115;&#103;&#114;&#097;&#116;&#099;&#104;&#064;&#114;&#101;&#100;&#104;&#097;&#116;&#046;&#099;&#111;&#109;</a></li>
</ul>

<h2 id="benefit-to-ovirt">Benefit to oVirt</h2>

<p>Before this feature was implemented, configure a VM to run with high performance workloads was not an easy straightforward mission to do and required the user to manually set the VM as such by going over all settings and check what is relevant and how to configure it.</p>

<p>Furthermore, few required features essential for improving VM performance were not supported at all by oVirt (for example: using huge pages, IO Thread pinning and CPU cache layer 3) and new features as Headless VMs can now be leveraged to suggest one solution of the best recommended configuration according to VM usage requirements.</p>

<p>This feature introduces a simple to manage solution for running a new/existing VM as High Performance via WebAdmin or REST api, while the user can still keep an option to manually change or ignore the suggested configuration for his own tuning and requirements.</p>

<h2 id="usage">Usage</h2>

<ul>
  <li>
    <p>Setting a VM to run as a High Performance VM can be done to a new or existing VM via UI by selecting the "High Performance" type in the "Optimized for" pull down menu field displayed in VM new/edit dialog. 
This new VM type is added in addition to already existed VM types: "Server", "Desktop".</p>
  </li>
  <li>
    <p>In case of changing the VM type for a running VM, part of the required configuration changes will require a VM restart after saving. In case of changing the VM type for a new/existed VM, part of the required/suggested configuration may require manually changes of the VM's cluster configuration prior to setting the VM as High-performance, and part of the required/suggested configuration may require changing of the specific pinned host configuration prior to setting the VM as High-performance.</p>
  </li>
  <li>
    <p>A High Performance Template or Pool can be created in the same way as a VM. In case the user wants to create a High Performance VM, he can also choose a Template or a Pool which are configured as High Performance type and "inherit" this property for that specific VM.</p>
  </li>
  <li>
    <p>Note that if an Instance Type is chosen for a VM, it has no influence on the VM high performance type and configuration. Nevertheless, configuration changed by the Instance Type may override the VM High Performance configuration.</p>
  </li>
  <li>Once the "High Performance" VM type was chosen in the VM/Template/Pool dialog,  a set of automatic configuration changes, and suggested manual configuration changes are proposed to the user in order to suggest the user with the optimal configuration setting:
    <ul>
      <li>
        <p>A list of validations and suggested manual configuration changes are displayed in a pop-up window on save and the user can choose if to accept and perform before saving or ignore them.</p>
      </li>
      <li>
        <p>A list of configuration changes will be applied automatically (and the user can cancel before saving via WebAdmin UI).</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Once the user accepts the configuration and clicks the OK button within the pop-up dialog, the configuration is changed accordingly and the VM becomes a High Performance VM.</p>
  </li>
  <li>
    <p>a new icon is displayed for this new High Performance VM type, left to the VM name, and the VM type will also be displayed in the "General" sub-tab (it is required since no icons are displayed for Pools and Templates).</p>
  </li>
  <li>
    <p>This feature doesn't work on all cluster levels (since huge pages are not supported before oVirt 4.2).</p>
  </li>
  <li>Note that all of the scenarios described above can be done in UI only via oVirt WebAdmin and not via the UserPortal.</li>
</ul>

<h2 id="detailed-description">Detailed Description</h2>

<p>As described above, the configuration settings is divided into configuration changes done automatically (and the user can change before saving) and suggested configuration changes/warnings which are proposed to the user to perform before saving.</p>

<h3 id="list-of-automatic-configuration-settings-for-high-performance-vm">List of automatic configuration settings for High Performance VM</h3>

<h4 id="enable-headless-mode-and-enable-serial-console"><strong>Enable Headless Mode and enable Serial console</strong></h4>
<p>Displayed in console side-tab of the VM dialog.</p>

<p>For Headless VM handling please see http://www.ovirt.org/develop/release-management/features/virt/headless-vm</p>

<h4 id="disable-all-usb-devices"><strong>Disable all USB devices</strong></h4>
<p>Displayed in console side-tab of the VM dialog.</p>

<p>This is a new configuration setting added for oVirt 4.2.</p>

<h4 id="disable-the-sound-card-device"><strong>Disable the Sound Card device</strong></h4>
<p>Displayed in console side-tab of the VM dialog</p>

<h4 id="disable-the-smart-card-device"><strong>Disable the Smart Card device</strong></h4>
<p>Displayed in console side-tab of the VM dialog</p>

<h4 id="enable-pass-through-host-cpu"><strong>Enable Pass-Through Host CPU</strong></h4>
<p>Displayed in Host side-tab of the VM dialog.</p>

<p>This option can only be enabled when VM live migration is disabled.</p>

<h4 id="disable-vm-migration"><strong>Disable VM migration</strong></h4>
<p>Displayed in 'Host' side-tab of the VM dialog.</p>

<p>The VM cannot be migrated, either automatically or manually for oVirt 4.2. 
Support migration is planned for oVirt 4.3 . See https://bugzilla.redhat.com/show_bug.cgi?id=1457250.</p>

<h4 id="enable-io-threads-num-of-io-threads--1"><strong>Enable IO Threads, Num Of IO Threads = 1</strong></h4>
<p>Displayed in 'Resource Allocation' side-tab of the VM dialog.</p>

<p>Current configuration is changed by removing the 'Num Of IO Threads' field from the UI so that in case enabled, only one IO thread is always created.  For REST api the configuration remains unchanged so the user can still set the number of IO threads to be &gt;= 1.</p>

<h4 id="disable-the-memory-balloon-device"><strong>Disable the Memory Balloon Device</strong></h4>
<p>Displayed in 'Resource Allocation' side-tab of the VM dialog.</p>

<p>This option can also be set manually by the user for the cluster of that VM (add/edit Cluster dialog-&gt;Optimization side-tab).</p>

<h4 id="enable-high-availability-only-for-pinned-hosts"><strong>Enable High availability only for pinned hosts</strong></h4>
<p>Displayed in 'High Availability' side-tab of the VM dialog.</p>

<p>Currently High availability is not supported when migration is disabled.</p>

<p>High Performance VMs will be treated differently and will support High availability, but only for the VM's pinned host(s). This will allow re-running of the VM on the same pinned host or the next pinned host in case there are more than one.
 The High availability support will be expanded to all cluster hosts as part of the solution for supporting migration in oVirt 4.3.</p>

<h4 id="disable-the-watchdog-device"><strong>Disable the Watchdog device</strong></h4>
<p>Displayed in 'High Availability' side-tab of the VM dialog.</p>

<h4 id="enable-paravirtualized-random-number-generator-pci-virtio-rng-device"><strong>Enable paravirtualized Random Number Generator PCI (virtio-rng) device</strong></h4>
<p>Displayed in 'Random Generator' side-tab of the VM dialog.</p>

<p>This option is automatically set using libvirt defaults ("Period duration"=1000 milliseconds) and can be changed by the user before saving.</p>

<h4 id="enable-multi-queues-per-virtual-interface"><strong>Enable Multi Queues per Virtual Interface</strong></h4>
<p>This is a new configuration setting added for oVirt 4.2.</p>

<p>Displayed in 'Resource Allocation' side-tab of the VM dialog.</p>

<h4 id="set-the-io-and-emulator-threads-pinning-topology"><strong>Set the IO and Emulator threads pinning topology</strong></h4>
<p>This is a new configuration setting added for oVirt 4.2.</p>

<p>This option will be automatically configured and calculated in engine side and the recommended calculated pinning topology will be sent to the host in libvirt xml.
No UI settings are required for this option.</p>

<p>The automatic calculated pinning topology for IO and emulator threads will assume the following:</p>

<ul>
  <li>
    <p>It is requires that IO threads, CPU pinning topology and vNUMA and NUMA pinning are enabled and set for the VM. In case not, a warning will be displayed in a pop-up and the user will be asked to set it.</p>
  </li>
  <li>
    <p>The automatic IO thread pinning will be done by pinning to CPUs (of the pinned NUMA node) that are responsible for the IO in the host, or alternatively pinned to CPU#0 as this is typically the one.</p>
  </li>
  <li>
    <p>The first two CPUs per NUMA node will be reserved for IO+Emulator threads. The default value will be set to "0,1". Such configuration would imply that two CPUs, 0th and 1st in each NUMA node, will be used for IO + Emulator thread pinning for each High Performance VM.</p>

    <p>If all VM's CPUs fit to one NUMA node of the host, then those first two CPUs are reserved for emulator + IO pinning and the rest will be used for vCPU pinning.</p>
  </li>
  <li>
    <p>Additional logic is required to avoid wasting CPUs for large single High Performance VMs that span more then one NUMA node. For such VMs, the engine will find the most pinned NUMA node (i.e. the NUMA node that most vCPUs are pinned to), pins the IO and emulator to the first two CPUs of that NUMA node and leaves the next pinned NUMA node(s) to be used for vCPU pinning only.</p>
  </li>
  <li>
    <p>In case the list of CPUs pinned to vCPUs and the list of CPUs pinned to IO+emulator threads are overlapping, a warning will be displayed in the log and the user will be asked to fix it.</p>
  </li>
  <li>
    <p>Note that Pools are not supporting IO+Emulator threads pinning (since NUMA pinning is not supported for Pools, see "Enable virtual NUMA and set NUMA pinning topology" section for details).</p>
  </li>
</ul>

<h3 id="list-of-manual-configuration-settingswarnings-for-high-performance-vm">List of manual configuration settings/warnings for High Performance VM</h3>

<h4 id="set-the-cpu-pinning-topology"><strong>Set the CPU Pinning topology</strong></h4>
<p>Displayed in 'Resource Allocation' side-tab of the VM dialog.</p>

<p>In case the CPU Pinning topology is not set upon VM saving, a recommendation/warning will be displayed in a pop-up and the user will be asked to pin the VM to a host (by selecting the "Start running on: Specific Host" in "Host" side-tab) and verify if VM configuration fits the host configuration (i.e. guest_number_of_cores_per_socket &lt;= host_number_of_cores_per_socket,  guest_threads_per_core &lt;= host_threads_per_core and guest_number_of_sockets &lt;= host_number_of_sockets).</p>

<p>Ideally the CPU pinning should be done automatically and not manually by the user, but in first phase we will not support it.</p>

<p>Note that since this configuration option can be set for VMs and Pools and not for Templates, then the user should always set this field when creating a VM or a Pool, even if it is based on a High Performance Template.</p>

<h4 id="enable-virtual-numa-and-set-numa-pinning-topology"><strong>Enable virtual NUMA and set NUMA pinning topology</strong></h4>
<p>Displayed in 'Host' side-tab of the VM dialog.</p>

<p>In case the virtual NUMA and the NUMA pinning topology are not set upon VM saving, a recommendation/warning will be displayed in a pop-up and the user will be asked to pin the VM to a host that supports NUMA topology and verify the VM NUMA topology fits the host's NUMA topology.</p>

<p>Ideally the NUMA pinning should be done automatically according to the exposed host's NUMA topology and not manually by the user, but in first phase we will not support it.</p>

<p>Note that this configuration option can be set for VMs and not for Templates or Pools. Therefore, the user should always set NUMA configuration when creating a VM based on a Template, while for Pools NUMA pinning is not supported at all.</p>

<h4 id="disable-kernel-same-page-merging-ksm"><strong>disable kernel same page merging (KSM)</strong></h4>
<p>This is currently implemented in engine only for cluster level (new/edit cluster dialog-&gt;'Optimization side-tab).</p>

<p>KSM can be manually deactivated in host level by stopping the ksmtuned and the ksm service on the hypervisor.</p>

<p>Disabling the KSM for the specific VM may be implemented for oVirt 4.3 if required. This should be implemented by adding a check-box to the 'Resource Allocation' side-tab of the VM dialog and implemented by setting the "nosharepages" domain property in libvirt xml (requires  VDSM changes).</p>

<p>In case that KSM in cluster level or host level is not disabled upon VM saving, a recommendation/warning will be displayed in a pop-up and the user will be asked to disable it either in cluster level, host level or for the specific VM.</p>

<h4 id="enable--memory-backing-with-huge-pages"><strong>Enable  memory backing with huge pages</strong></h4>
<p>This is a new configuration setting added for oVirt 4.2. 
This feature includes host side changes in addition to engine and UI changes. The UI changes will be added as a predefined new key option in the 'Custom Properties' side-tab of the VM dialog. 
This new "hugepages" key will allow to set the size of the huge page in kB.</p>

<p>In case that huge pages configuration is not set upon VM saving, a recommendation/warning will be displayed in a pop-up and the user will be asked to set it and verify it fits the host configuration (i.e. guest huge pages selected size should be supported by the pinned host, recommending to set the biggest pages available and also checking that guest_number_of_huge_pages_for_selected_size &lt;= host_number_of_huge_pages_for_selected_size).</p>

<p>For more information please see https://trello.com/c/ABUiJgWR/62-hugepages</p>

<h3 id="webadminuserportal-ui">WebAdmin/UserPortal UI</h3>

<p><img alt="" src="/images/../../../../images/wiki/Screenshot_from_2017-06-15-10-46-39.png" /></p>

<ul>
  <li>
    <p>A new "High Performance" type is added to the "Optimized for" pull down menu field displayed in VM/Template/Poll for new and edit dialogs.</p>
  </li>
  <li>
    <p>New icons are added to display this new VM type + modes (Stateless/Stateful, with/without new configuration, Vm in a Pool/regular VM).</p>
  </li>
  <li>
    <p>The VM/Template/Pool "optimized for" type (values: "Server", "Desktop" or "High Performance") will be displayed in the "General" sub-tab.</p>
  </li>
  <li>
    <p>The 'Num Of IO Threads' field was removed from 'Resource Allocation' side-tab of the VM dialog</p>
  </li>
  <li>
    <p>A list of validations and suggested manual configuration changes are displayed in a new pop-up window on save of a High Performance VM/Template/Pool, and the user can choose if to accept and perform those changes before saving or ignore them.</p>
  </li>
</ul>

<h3 id="rest-api">REST API</h3>

<ul>
  <li>
    <p>a new 'High Performance' VM type should be added to VM/pool/Template creation/editing APIs.</p>
  </li>
  <li>
    <p>All relevant configuration changes mentioned above should be exposed in APIs, including the new features like huge pages configuration.</p>
  </li>
  <li>
    <p>There is no automatic settings for High Performance VM/Pool/Template via REST API and the user should set the configuration manually (except for IO+Emulator threads pinning, USB disabling and CPU cache layer 3 enabling which are set automatically in back-end).</p>
  </li>
  <li>
    <p>For creating a fully configured High Performance VM via REST API, the following set of API's should be called:</p>
    <ol>
      <li>Create a new VM based on pre-created High Performance Template and set 'host_passthrough' and host pinning since it is not part of the template.
Alternatively, if the new VM is based on a 'Blank' Template then the user should set the following required/recommended high performance configuration as part of the API request:
Enable host_passthrough, set cpu_pinning, disable soundcard, disable migration, disable balloon, enable serial console, enable huge pages, enable high availability, set io threads number to 1.</li>
    </ol>

    <p>An Example for creating a VM based on a high perfomance template:</p>

    <p>POST …/api/vm</p>

    <p>&lt;vm&gt;</p>

    <p>&lt;cluster&gt;&lt;name&gt;cluster_name&lt;/name&gt;&lt;/cluster&gt;</p>

    <p>&lt;name&gt;vm_name&lt;/name&gt;</p>

    <p>&lt;template&gt;&lt;name&gt;hp_template&lt;/name&gt;&lt;/template&gt;</p>

    <p>&lt;type&gt;HIGH_PERFORMANCE&lt;/type&gt;\</p>

    <p>&lt;cpu&gt;</p>

    <p>&lt;mode&gt;host_passthrough&lt;/mode&gt;</p>

    <p>&lt;cpu_tune&gt;&lt;vcpu_pins&gt;&lt;vcpu_pin&gt;&lt;vcpu&gt;0&lt;/vcpu&gt;&lt;cpu_set&gt;0&lt;/cpu_set&gt;&lt;/vcpu_pin &lt;/vcpu_pins&gt;&lt;/cpu_tune&gt;</p>

    <p>&lt;/cpu&gt;</p>

    <p>&lt;/vm&gt;</p>
  </li>
</ul>

<ol>
  <li>
    <p>For setting the VM as Headless and disable all USB devices, the user need to delete all graphic consoles by calling for each graphic console device:</p>

    <p>DELETE …/api/vms/&lt;vm-id&gt;/graphicsconsoles/&lt;console-id&gt;</p>
  </li>
  <li>
    <p>Set virtual NUMA nodes and NUMA pinning topology by calling:</p>

    <p>POST …/api/vms/&lt;vm-i&gt;d/numanodes</p>
  </li>
  <li>
    <p>Disable KSM for the VM's Cluster.</p>
  </li>
</ol>

<p>The same goes for Templates and Pools.</p>

<h2 id="status">Status</h2>

<ul>
  <li>Target Release: Ovirt 4.2</li>
  <li>Status: Merged</li>
</ul>

<h2 id="limitations">Limitations</h2>

<h2 id="dependencies--related-features">Dependencies / Related Features</h2>
<p>Headless VM</p>

<p>VM memory backing with huge pages</p>

</section>
</section>
</section>
<footer class='text-center' id='footer'>
<hr class='visible-print'>
<ul class='footer-nav-list'>
<li><a target="_blank" href="../../../../site/privacy-policy.html">Privacy policy</a></li>
<li><a target="_blank" href="../../../../community/about.html">About</a></li>
<li><a target="_blank" href="../../../../site/general-disclaimer.html">Disclaimers</a></li>
</ul>

&copy; 2013&ndash;2019 oVirt
<div class='edit-this-page'>
<a target="_blank" href="https://github.com/oVirt/ovirt-site/issues/new?labels=content&amp;title=Issue:%20/source/develop/release-management/features/virt/high-performance-vm.html.md&amp;template="><i class="icon fa fa-github"></i>Report an issue with this page</a>
</div>
<div class='edit-this-page'>
<a target="_blank" href="https://github.com/oVirt/ovirt-site/edit/master/source/develop/release-management/features/virt/high-performance-vm.html.md"><i class="icon fa fa-github"></i>Edit this page</a>
</div>
<div class='last-modified'>
Page last modified
Mon 16 Jul 2018 15:01 UTC
</div>
        <script type="text/javascript">
        var _paq = _paq || [];
        _paq.push(['trackPageView']);
        _paq.push(['enableLinkTracking']);
        (function() {
        var u=(("https:" == document.location.protocol) ? "https" : "http") + "://stats.phx.ovirt.org/";
        _paq.push(['setTrackerUrl', u+'piwik.php']);
        _paq.push(['setSiteId', 1]);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0]; g.type='text/javascript';
        g.defer=true; g.async=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
        })();
        </script>
<noscript><p><img src="https://stats.phx.ovirt.org/piwik.php?idsite=1" style="border:0;" alt="" /></p></noscript>
</footer>


<script src="/javascripts/application.js?1560777657" type="text/javascript"></script>

</body>
</html>
